{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5 text-center">
  <h2 class="mb-4 text-white">Selecciona tu vista</h2>
  <p class="text-muted">Escoge una vista y sube tu imagen para procesarla.</p>

  {% if error %}
    <div class="alert alert-warning">{{ error }}</div>
  {% endif %}

  {% if vistas %}
    <div class="row justify-content-center mb-4">
      {% for vista in vistas %}
      <div class="col-md-3 col-sm-4 col-6 mb-3">
        <div class="card bg-dark border-secondary text-white h-100">
          <img src="/media/lineas/{{ categoria }}/{{ vista }}" class="card-img-top rounded" alt="{{ vista }}">
          <div class="card-body p-2">
            <button type="button" class="btn btn-outline-light btn-sm" onclick="selectView('{{ vista }}')">
              Seleccionar
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning">⚠️ No se encontraron vistas dentro de la categoría seleccionada.</div>
  {% endif %}

  <form method="POST" enctype="multipart/form-data" class="mt-4">
    {% csrf_token %}
    <div class="mb-3">
      <label for="image" class="form-label text-white">Selecciona tu imagen</label>
      <input type="file" name="file" id="image" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-primary btn-lg">Subir y procesar</button>
  </form>
</div>

<script>
function selectView(view) {
  fetch(`/set-view/?view=${view}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        document.querySelectorAll('.card').forEach(el => el.classList.remove('border-success'));
        document.querySelector(`img[alt='${view}']`).closest('.card').classList.add('border-success');
      }
    });
}
</script>
{% endblock %}
