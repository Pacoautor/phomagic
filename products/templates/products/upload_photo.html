{% extends "products/base.html" %}
{% block title %}Subir foto y elegir vista{% endblock %}

{% block content %}
<h3>2) Sube tu foto y elige la vista</h3>

<form method="post" enctype="multipart/form-data" id="mainForm">
  {% csrf_token %}

  <fieldset>
    <legend>Tu foto</legend>
    {{ upload_form.as_p }}
  </fieldset>

  <fieldset>
    <legend>Vistas disponibles (elige una)</legend>
    {% if thumbnails %}
      <div class="thumb-grid">
        {% for num, url in thumbnails %}
          <label style="display:block">
            <img src="{{ url }}" alt="Vista {{ num }}">
            <div style="margin-top:6px">
              <input type="radio" name="view_number" value="{{ num }}" {% if forloop.first %}checked{% endif %}> Vista {{ num }}
            </div>
          </label>
        {% endfor %}
      </div>
    {% else %}
      <p>No se han encontrado vistas para esta categoría/subcategoría.</p>
    {% endif %}
  </fieldset>

  {% if selection.follow_logo %}
  <fieldset>
    <legend>Seguimiento de logotipo</legend>
    <p class="note">1) Dibuja un rectángulo rojo sobre tu foto (previsualización). 2) Sube el archivo del logotipo.</p>

    <!-- Previsualización del cliente: el usuario puede cargar su foto arriba; la mostramos al vuelo -->
    <div>
      <div class="canvas-wrap">
        <img id="previewImg" alt="Previsualización" style="max-width: 100%; display:none;">
        <div id="drawRect" class="logo-rect" style="display:none;"></div>
      </div>
    </div>

    <!-- Campos ocultos con porcentajes -->
    <input type="hidden" name="rect_x" id="rect_x">
    <input type="hidden" name="rect_y" id="rect_y">
    <input type="hidden" name="rect_w" id="rect_w">
    <input type="hidden" name="rect_h" id="rect_h">

    <div style="margin-top:10px">
      {{ logo_form.logo_file.label_tag }}<br>
      {{ logo_form.logo_file }}
    </div>
  </fieldset>
  {% endif %}

  <button type="submit" class="button-primary">Generar resultado</button>
</form>

<script>
(function() {
  const inputFile = document.querySelector('input[type="file"][name="client_photo"]');
  const img = document.getElementById('previewImg');
  const rect = document.getElementById('drawRect');
  const wrap = img ? img.parentElement : null;

  const hx = document.getElementById('rect_x');
  const hy = document.getElementById('rect_y');
  const hw = document.getElementById('rect_w');
  const hh = document.getElementById('rect_h');

  if (inputFile) {
    inputFile.addEventListener('change', function(ev) {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      img.src = url;
      img.style.display = 'block';
      rect.style.display = 'none';
      // Reset
      hx.value = ''; hy.value = ''; hw.value = ''; hh.value = '';
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    });
  }

  let startX = 0, startY = 0;
  let dragging = false;

  function relPos(e) {
    const r = img.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width;
    const y = (e.clientY - r.top) / r.height;
    return {x: Math.max(0, Math.min(1, x)), y: Math.max(0, Math.min(1, y))};
  }

  function onDown(e) {
    if (img.style.display === 'none') return;
    dragging = true;
    const p = relPos(e);
    startX = p.x; startY = p.y;
    rect.style.display = 'block';
    updateRect(p.x, p.y);
    e.preventDefault();
  }

  function onMove(e) {
    if (!dragging) return;
    const p = relPos(e);
    updateRect(p.x, p.y);
  }

  function onUp(e) {
    if (!dragging) return;
    dragging = false;
    const r = computeRectPercent();
    hx.value = (r.x * 100).toFixed(2);
    hy.value = (r.y * 100).toFixed(2);
    hw.value = (r.w * 100).toFixed(2);
    hh.value = (r.h * 100).toFixed(2);
  }

  function updateRect(currX, currY) {
    const r = img.getBoundingClientRect();
    const x = Math.min(startX, currX);
    const y = Math.min(startY, currY);
    const w = Math.abs(currX - startX);
    const h = Math.abs(currY - startY);

    rect.style.left = (x * r.width) + 'px';
    rect.style.top = (y * r.height) + 'px';
    rect.style.width = (w * r.width) + 'px';
    rect.style.height = (h * r.height) + 'px';
  }

  function computeRectPercent() {
    const r = img.getBoundingClientRect();
    const x = parseFloat(rect.style.left || 0) / r.width;
    const y = parseFloat(rect.style.top || 0) / r.height;
    const w = parseFloat(rect.style.width || 0) / r.width;
    const h = parseFloat(rect.style.height || 0) / r.height;
    return {x, y, w, h};
  }

  if (wrap) {
    wrap.addEventListener('mousedown', onDown);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
    // Soporte táctil básico
    wrap.addEventListener('touchstart', (e) => onDown(e.touches[0]));
    window.addEventListener('touchmove', (e) => onMove(e.touches[0]));
    window.addEventListener('touchend', (e) => onUp(e.changedTouches[0]));
  }
})();
</script>
{% endblock %}
